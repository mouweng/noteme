# 一致性Hash算法

- [5分钟理解一致性哈希算法](https://juejin.cn/post/6844903750860013576)
- [好刚: 7分钟视频详解一致性hash 算法](https://www.bilibili.com/video/BV1Hs411j73w?spm_id_from=333.337.search-card.all.click)

## 分布式缓存存在的问题

随着业务的扩展，流量的剧增，单体项目逐渐划分为分布式系统。分布式系统中，我们一般使用**hash算法**来解决数据存储到哪一台缓存服务器的问题。但是hash算法也会面临容错性和扩展性的问题：

- 现假设有一台Redis服务器宕机了，此时每个key就要按`h = Hash(key) % 2`重新计算。
- 同样，如果新增一台服务器，规则也同样需要重新计算，`h = Hash(key) % 4`。

因此，系统中如果有服务器更变，会直接影响到Hash值，大量的key会重定向到其他服务器中，造成缓存命中率降低，而这种情况在分布式系统中是十分糟糕的。

## 一致性Hash算法

### 原理

> 一致性哈希是将整个哈希值空间组织成一个虚拟的圆环。

如假设哈希函数H的值空间为`0~2^32-1`（哈希值是32位无符号整形），整个空间按顺时针方向组织，0和2^32-1在零点中方向重合。

接下来，把服务器按照IP或主机名作为关键字进行哈希，这样就能确定其在哈希环的位置。

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281528679.png)

然后，我们就可以使用哈希函数H计算值为key的数据在哈希环的**具体位置h**，根据h确定在环中的具体位置，从此位置**沿顺时针滚动，遇到的第一台服务器**就是其应该定位到的服务器。

### 举例

#### 映射

例如我们有A、B、C、D四个数据对象，经过哈希计算后，在环空间上的位置如下：

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281529874.png)

根据一致性哈希算法，数据`A`会被定为到`Server 1`上，数据`B`被定为到`Server 2`上，而`C`、`D`被定为到`Server 3`上。

#### 容错

> 假如RedisService2宕机了，那么会怎样呢？

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281531529.png)

那么，数据B对应的节点保存到RedisService3中。因此，其中一台宕机后，干扰的只有前面的数据（原数据被保存到顺时针的下一个服务器），而不会干扰到其他的数据。

#### 扩展

> 假如增加一台服务器Redis4，那么会怎样呢？

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281532047.png)

原本数据C是保存到Redis3中，但由于增加了Redis4，数据C被保存到Redis4中。干扰的也只有Redis3而已，其他数据不会受到影响。

### 虚拟节点

#### 倾斜问题

> 如果节点较少就会出现节点分布不均衡造成数据倾斜问题。

例如，我们的的系统有两台Redis，分布的环位置如下图所示：

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281534125.png)

这会产生一种情况，Redis1的hash范围比Redis2的hash范围大，导致数据大部分都存储在Redis1中，**数据存储不平衡**。

#### 虚拟节点机制

> 为了解决这种数据存储不平衡的问题，一致性哈希算法引入了**虚拟节点机制**，即对每个节点计算多个哈希值，每个计算结果位置都放置在对应节点中，这些节点**称为虚拟节点**。

具体做法可以在服务器IP或主机名的后面增加编号来实现，例如上面的情况，可以为每个服务节点增加三个虚拟节点，于是可以分为 RedisService1#1、 RedisService1#2、 RedisService1#3、 RedisService2#1、 RedisService2#2、 RedisService2#3，具体位置如下图所示：

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202203281535357.png)

对于数据定位的hash算法仍然不变，只是增加了虚拟节点到实际节点的映射。例如，数据C保存到虚拟节点Redis1#2，实际上数据保存到Redis1中。这样，就能解决服务节点少时数据不平均的问题。在实际应用中，通常将虚拟节点数设置为**32甚至更大**，因此即使**很少的服务节点**也能做到相对**均匀的数据分布**。

## 总结

本文简要的介绍了一致性哈希算法，目前一致性哈希算法基本成为了分布式系统组件的标准配置，因此，我们十分有必要了解该算法。