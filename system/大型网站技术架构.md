# 大型网站技术架构

> 高性能、可用性、伸缩性、扩展性、安全性是大型网站架构中最核心的几个要素。

## 大型网站特点

- 高并发、大流量
- 高可用
- 海量数据
- 用户分布广泛，网络情况复杂
- 安全环境恶劣
- 需求变更快速，发布频繁
- 渐进式法则

## 大型网站架构演化

### 1. 初始阶段的网站架构

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191053846.jpg)

应用程序、数据库、文件等所有资源在一台服务器上。

### 1. 应用服务和数据服务分离

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191053000.jpg)

应用和数据分离后整个网站使用三台服务器：应用服务器、文件服务器、数据库服务器。

### 3. 使用缓存改善网站性能

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191058256.jpg)

80%的业务访问集中在20%的数据上，故可以使用缓存改善性能。

- 应用服务器上的本地缓存：访问速度快，但内存容量受限，且出现和应用程序争用内存的情况
- 专门的分布式缓存服务器：使用集群方式，理论上可以做到内存容量不受限制

### 4. 使用应用服务器集群改善网站的并发处理能力

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191054940.jpg)

添加应用服务器集群，通过负载均衡调度器（可以是Nginx），可将来自用户浏览器的访问请求分发到应用服务器集群。

### 5. 数据库读写分离

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191054386.jpg)

数据库使用搭建主从复制，实现读写分离。

### 6. 使用反向代理和CDN加速网站响应

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191054948.jpg)

使用反向代理和CDN加速网站访问。

CDN和反向代理的基本原理都是缓存，一方面尽早返回数据给用户，另一方面减轻后端服务器负载压力

- CDN部署在网络提供商的机房，使用户在请求网站服务时，可以从距离自己最近的网络提供商机房获取数据
- 反向代理部署在网站的中心机房，当用户请求到达中心机房后，首先访问反向代理服务器，如果反向代理中缓存着用户请求的资源，则直接返回给用户。

### 7. 使用分布式文件系统和分布式数据库系统

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191055388.jpg)

搭建文件服务器和数据库服务器集群

### 8. 使用NoSQL和搜索引擎

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191055274.jpg)

使用非关系数据库NoSQL和非数据库查询技术如搜索引擎等。

NoSQL和搜索殷勤都是源自互联网的技术手段，对可伸缩的分布式特性具有更好的支持。应用服务器则通过一个统一的数据访问模块访问各种数据，减轻应用程序管理诸多数据源的麻烦。

### 9. 业务拆分

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191055744.jpg)

根据不同的产品线（例如首页、商铺、订单、买家、卖家等），将网站拆分成许多不同的应用，每个应用独立部署维护。应用之间的可以通过RPC和消息队列等进行通信。当然最多的还是通过访问同一个数据存储系统来构成一个关联的完整系统。

### 10. 分布式服务

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204191055527.jpg)

把业务里面的用户管理、商品管理等共同业务提取出来，独立部署。（中台？）

## 大型网站架构模式

### 分层

网站系统分为应用层、服务层、数据层

- 应用层：负责具体业务和视图展示
- 服务层：为应用层提供服务支持
- 数据层：提供数据存储访问服务

在网站规模还很小的时候，就应该采用分层的架构，这样将来网站做大才能更好地应对。

分层架构是逻辑上的，在物理部署上，三层结构可以部署在同一个物理机器上，但是随着网站业务的发展，必然需要对已经分层的模块分离部署，即三层机构分别部署在不同的服务器上，使网站拥有更多的计算资源以应对更多用户的访问。

在实践中，大的分层结构内部还可以继续分层，如应用层可以再细分为视图层（美工负责）和业务逻辑层（工程师负责）；服务层可以细分为数据接口层（适配各种输入和输出的数据格式）和逻辑处理层。

### 分割

分层是对软件在横向上进行切分，而分割则是在纵向方面对软件进行切分。

按不同业务进行分割，例如将购物、论坛、搜索、广告分割成不同的应用，由独立的团队负责，部署在不同的服务器上。

### 分布式

分层和分割可能都需要使用分布式进行部署。

分布式解决网站高并发问题的同时也带来了其他问题：分布式意味着服务调用必须经过网络，造成性能瓶颈；服务器越多，宕机概率也越大，需要保证一定的容错；数据在分布式环境中保持一致性也比较困难，分布式事务也难以保证；分布式还导致维护比较困难。

分布式有以下几种：

- 分布式应用和服务
- 分布式静态资源
- 分布式数据和存储
- 分布式计算

此外还有可以支持网站线上服务配置实时更新的分布式配置；分布式环境下实现并发和协同的分布式锁；支持云存储的分布式文件系统等。

### 集群

使用分布式将分层和分割独立不是，但是对于几种集中的模块（比如首页），还需要将独立部署的服务器集群化，即多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。

因为服务器集群有更多服务器提供相同服务，因此可以提供更好的并发特性，当有更多用户访问的时候，只需要向集群中加入新的机器即可。同时因为一个应用有多个服务器提供，发生故障时会自动请求转发到其他服务器上，实现容错。

即使访问量很小的分布式应用和服务，也至少要部署两台服务器构成一个小的集群，目的是提高系统的可用性。

### 缓存

将数据存放在距离最近的位置以加速处理，改善性能。

- **CDN**：内容分发网络，部署在距离终端用户最近的网络服务商，用户的网络请求总是优先到达网络服务商那里，哪里缓存着一些网站的静态资源（变化较少的数据），可以以最快的速度返回给用户，如视频网站和门户网站会将用户访问量大的热点内容缓存在CDN上
- **反向代理**：反向代理属于网站前段架构的一部分，部署在网站前端，用户请求到达时最先访问的就是反向代理服务器，这里缓存着网站的静态资源，无需将请求转发给应用服务器就能返回给用户。例如Nginx就实现了反向代理和负载均衡功能！
- **本地缓存**：应用服务器本地缓存着的热点数据，应用程序可以在本机内存中直接访问，而无需访问数据库。
- **分布式缓存**：将数据缓存在一个分布式缓存集群中，应用程序通过网络通信访问缓存数据。

### 异步

在单一服务器内部可以通过多线程共享内存队列的方式实现异步；在分布式系统中可以使用分布式消息队列实现异步；

- **提高系统可用性**：消费者服务器发生故障，数据会在消息队列服务器中进行堆积，生产者服务器可以继续处理业务请求，系统整体表现无故障。消费者服务器恢复正常后，继续处理消息队列中的数据。

- **加快网站响应速度**：处在业务处理前端的生产者服务器在处理完业务请求后，将数据写入消息队列，不需要等待消费者服务器处理就可以返回，响应延迟减少。

- **消除并发访问高峰**：将突然暴增的访问请求数据放入消息队列中，消费者依次处理，不会对整个网站负载造成太大压力。

⚠️使用异步方式处理业务可能会对用户体验、业务流程造成影响，得具体业务具体分析！

### 冗余

- 数据库定期备份，存档保存，实现冷备份外，为了保证在线业务高可用，还需要对数据库进行主从分离，实时同步实现热备份。

- 为了低于自然灾害（地震、海啸）等不可抗力因素，大型网站会对整个数据中心进行备份，全球范围内部署**灾备数据中心。**

### 自动化

- 自动化代码管理：代码版本控制、代码分支创建合并等自动化；
- 自动化测试：进行自动化用例测试，向相关人员发送测试报告，向系统反馈测试结果；
- 自动化安全检测：安全检测工具通过对代码进行静态安全扫描及部署到安全测试环境进行安全攻击测试，评估其安全性；
- 自动化部署：将工程代码自动部署到线上生产环境（CI/CD）
- 自动化监控：对服务器进行心跳检测，并监控其各项性能指标和应用程序的关键数据指标
- 自动化报警：发现异常、超出预设的阈值，进行告警
- 自定化失效转移：将失效的服务器从集群中隔离出去，不再处理系统请求。
- 自动化失效恢复：重启服务器，自动回复
- 自动化降级：遇到访问高峰，超出网站最大处理能力时，保证整个网站的安全可用，自动降级，拒绝请求及关闭部分不重要服务。
- 自动化分配资源：将空闲资源分配给重要的服务，扩大其部署规模

### 安全

- 通过密码和手机校验码进行身份认证
- 登陆、交易等操作需要对网络通信进行加密网站服务器上存储的敏感数据如用户信息也进行加密处理；
- 为了防止机器人程序滥用网络资源攻击网站，网站使用验证码进行识别；
- 对于常见的用于网络攻击的XSS攻击、SQL注入、进行编码转换等相应处理；
- 对于垃圾信息、敏感信息进行过滤
- 对交易转账等重要操作根据交易模式和交易信息进行风险控制

