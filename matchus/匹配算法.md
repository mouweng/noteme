# 匹配算法

## 业务描述

### 场景

将匹配池子分为两个列表（男生列表和女生列表），参与匹配的每个用户定义为MatchUser，包含如下信息：

```java
class MatchUser {
  User user; // 用户
  PersonInfo personInfo; // 个人信息
  MatchRequest matchRequest; // 匹配问卷
  Integer appearence; // 颜值
  Integer lucky; // 幸运值
}
```

![](./pics/table.png)

- User：包含用户的注册信息（ID、姓名、学号、性别、学院等信息）
- PersonInfo：包含用户的个人信息（家乡、身高、体重、校区等等）
- MatchRequest：问卷信息（包含各种匹配问题及其回答，下面仅包含问题部分）
- Appearence：系统给的颜值打分
- Lucky：系统幸运值

### 匹配目标

- 当男女互相符合对方匹配问卷时，可以成为一个匹配对。

- 每个用户只能匹配一个用户。

- 针对平台：输出**最大化**匹配对数（平台收益最大化）。
- 针对用户：尽可能为每个用户匹配**"最合适"**的人选。

## 算法架构

![](./pics/alg_arch.png)

- Mysql：数据全部存储在Mysql中，需要从Mysql中拉取数据。

  1. 查询User（与user_activity联表，校验是否参与了活动）

  2. 查询PersonInfo。
  3. 查询MatchRequest（查询好多张问卷相关表）。
  4. 查询Appearence颜值表。
  5. 查询Lucky幸运值表。
  6. 组装信息，返回结果。

- Redis

  - 由于每次匹配从库中拉取数据非常慢（1H），所以考虑直接将组装好的数据MatchUser存入Redis。
  - 第二次重新取数据直接从Redis中拿。
  - 后续仔细思考了一下，获取数据的时候，也可以做并发读，也可以不用redis，存储到本地即可。

- DataUtil

  - 拉取数据的工具类，包含历史匹配数据、问卷名字表、从数据库中查询MatchUser、Redis写入、读取与删除工具

- 连边计算

  - 统计男女双方是否双向匹配（满足必选条件）。

  - MatchUser经过一个handler集合（主要包含必选条件、可选条件）

    - 如果男生符合女生必选条件，计算并返回not_match_num1（未满足可选要求的数量）， 否则返回-1。

    - 如果男生符合男生条件，计算并返回not_match_num2（未满足可选要求的数量），否则返回-1。

      > 注意这里的not_match_num1和not_match_num2会被用来做权值的扣分

    - 如果只要一方不符合（-1），则两者之间没有边。

- 权值计算

  - 统计男女双方匹配程度（权值），权值分为以下几个部分组成

    - 初始化分数：100

    - 可选要求中未满足数量：not_match_num1+not_match_num2

    - 系统权值匹配分：包含颜值、家乡、未来发展地、一年内状态、消费水平、消费分担、兴趣爱好、运动频率、熬夜频率、身高、年龄在内的系统权值计算规则

      https://tnh0kmeq9n.feishu.cn/wiki/wikcnXWSGCUzNzUYgU8vXiV8tXe

  - 赋分规则为：初始化分数 + 系统权值匹配分 - 可选要求中未满足数量

- 最大费用流

  - 核心算法，在满足限制条件（一个人只能匹配一个人）的前提下，找到最大匹配对，使得总分数或总收益最大化。

- 结果输出

  - 匹配失败报告
  - 匹配成功对数
  - 幸运值加减等后续业务

## 费用流算法

**费用流（Cost Flow）算法**是一种在网络图中用来解决 **最小费用最大流** 或 **最大费用最大流** 问题的经典算法。它的主要目标是找到一种流量分配方式，使得：

- 在满足流量约束的前提下，最大化（或最小化）流量的总费用。
- 在流网络中分配流量，使得流量的“收益”或“代价”达到最优。

**流网络模型**

费用流问题依赖于一个流网络，流网络通常包含以下元素：

- 节点：图中的顶点，代表实体或者状态，例如：男生节点、女生节点、源点（`source`）、汇点（`sink`）？
- 连边：图中的有向边，表示从一个节点到另一个节点的关系。
  - 容量（Capacity）：该边可容纳的最大流量，例如，一个男生最多只能与一个女生匹配。
  - 费用（Cost）：单位流量通过该边的代价或收益。例如，男生和女生之间匹配的权重（如分数、收益等）。

**最大费用最大流**

在最大费用流问题中，我们的目标是：

- 最大化流量的总费用：在满足流量约束（容量约束）的前提下，找到一条流量分配方案，使得流网络中的总费用（或总收益）最大化。

**费用流在匹配场景中的应用**

问题描述：给定两组实体（例如男生和女生），以及它们之间的关联权重，目标是匹配两个群体，使得总权重最大化。

使用费用流算法，可以在满足限制条件（例如一个人只能匹配一个人）的前提下，找到匹配对，使得总分数或总收益最大化。

**如何确保匹配对数最大化**？

设置一个初始的匹配分数100分。





## 算法的演进

手工时代

初代算法




## 后续算法的演进

