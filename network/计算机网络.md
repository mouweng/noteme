## 计算机网络

## 常见的应用层协议

| 应用程序 | FTP   | TELNET | SMTP | POP3 | HTTP | DNS  | TFTP |
| -------- | ----- | ------ | ---- | ---- | ---- | ---- | ---- |
| 协议     | TCP   | TCP    | TCP  | TCP  | TCP  | UDP  | UDP  |
| 端口号   | 20/21 | 23     | 25   | 110  | 80   | 53   | 69   |

## OSI模型

![OSI七层模型](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301195717.webp)

## 地址解析协议ARP

> ARP协议是实现从IP地址到MAC地址的转换。

![ARP](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301202157.jpg)

当路由器A要传输信息给路由器B时，这是IP报文只有IP地址，所以要查询B的MAC地址。

- A中会有一个ARP高速缓存，如果里面有B的地址，则直接找到；

- 如果没有，则会发送ARP请求广播，主机B收到广播后会发送响应报文给A，A把它写到自己的高速缓存中。

![ARP广播](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301202219.png)

## IP地址分类

![IP地址分类](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204011511567.jpg)

- 一个A类IP地址由1字节的网络地址和3字节主机地址组成，网络地址的最高位必须是0。可用的A类网络有126个，每个网络能容纳1亿多个主机。
- 一个B类IP地址由2个字节的网络地址和2个字节的主机地址组成，网络地址的最高位必须是10。可用的B类网络有16382个，每个网络能容纳6万多个主机 。

- 一个C类IP地址由3字节的网络地址和1字节的主机地址组成，网络地址的最高位必须是110。C类网络可达209万余个，每个网络能容纳254个主机。
- 一个D类IP地址第一个字节以1110开始，它是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。

## TCP和UDP的区别

|          | UDP                                                          | TCP                                                          |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连接类型 | 无连接，提供最大可能交付                                     | 有链连接，提供可靠交付                                       |
| 拥塞控制 | 无                                                           | 有                                                           |
| 流量控制 | 无                                                           | 有                                                           |
| 面向对象 | 面向报文（对于应用层传下来的报文不合并也不拆分，只是添加 UDP 首部） | 面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块） |
| 其他     | 支持一对一、一对多、多对一和多对多的交互通信                 | 每一条 TCP 连接只能是点对点的                                |
| 使用场景 | 即时通信、音视频传输                                         | 文件传输、发送和接收邮件、远程登录等场景。                   |
| 协议     | DNS                                                          | HTTP、POP3、STMP、Telnet、FTP                                |

## TCP特点

### TCP发送数据单位

- 建立连接时，可以确定发送数据包的单位，成为最大消息长度MSS。

- TCP在传送数据时一MSS为单位。

- MSS是在三次握手的时候，在两端主机之间被计算得出的。

### 停止等待协议

> 每发送完一个分组就停止，先等待对方确认再发送

- 通过序列号与确认应答提高可靠性，收到消息后回复ACK（seq=x+1)，x为收到上一份数据的末尾。
- 主机A发出的报文因为网络原因丢失，没收到ACK，则会在特定间隔内重新发送。
- 超时重发的时间比一次往返时间稍微大一点，是动态进行调整的。

### 连续ARQ协议

>每发送一个数据包就进行一次ACK，这种方式通行效率低下，所以就有了滑动窗口机制。

- 确认分段不在以是一个数据包为单位，而是以一个窗口内的数据包为单位。

- 滑动窗口对顺序到达的最后一个分组进行确认
- 如果出现数据包丢失，同一个序列号确认应答会不会重复返回，如果连续返回三次，则对应数据重传。

## TCP流量控制和拥塞控制

### 流量控制和拥塞控制的区别

- 流量控制是通过设置确认报文的窗口字段而告知对方，用来控制发送方的窗口大小。
- 拥塞控制和流量控制的区别是流量控制是控制的接收方，拥塞控制控制的整个网络。

### 流量控制

TCP提供发送端根据接收端实际接受能力控制发送的数据量。

接收端在TCP头部的字段中告诉发送端自己可以接受的窗口大小，于是发送端就不会发送超过这个窗口的数据。（这里也就是控制滑动窗口的值）

### 拥塞控制要点

拥塞控制的四个要点是：慢开始、拥塞避免、快重传和快恢复。

![拥塞控制](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301203124.png)

- **慢开始和拥塞避免**

指的是每次从一个报文开始发，只要收到回复报文，下一次发送的报文数目就加倍，1，2，4，8...知道到达设定的阈值s，开始进行拥塞避免，每次只增加1个报文，直到发生超时，则发送报文数目降到1，阈值为超时的1/2，重新进行慢开始。

- **快重传和快恢复**

在拥塞避免发生超时时，连续收到3个ack重复确认，则代表不是网络发生拥塞，而是报文丢失，这时候报文直接从当前报文数量/2开始增长，这叫快重传和快恢复

## TCP三次握手和四次挥手

### 三次握手

![三次握手过程](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301203643.png)

- 为什么要采用三次握手？

> 第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

采用三次握手是为了防止失效的连接请求报文段突然又传送到主机S，因而产生错误。主机C发出的连接请求没有收到主机S的确认，于是经过一段时间后，主机C又重新向主机S发送连接请求，且建立成功，顺序完成数据传输。考虑这样一种特殊情况，主机C第一次发送的连接请求并没有丢失，而是因为网络节点导致延迟达到主机S，主机S以为是主机C又发起的新连接，于是主机S同意连接，并向主机C发回确认，但是此时主机C根本不会理会，主机S就一直在等待主机C发送数据，导致主机S的资源浪费。

### 四次挥手

![四次挥手过程](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/20220301203708.png)

- 为什么连接的时候是三次握手，关闭的时候却是四次握手？

> 客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

因为在请求连接的时候，C和S之间是没有发生数据传输的，所以C发送请求报文时，S可以同时恢复一个SYN和ACK报文，以表示确认收到和同意连接。

但是在断开连接的时候，当C发送FIN终止报文的时候，S收到FIN终止报文，但是S可能还有数据没有传输完，所以先回复一个ACK，然后等数据传输完毕，再回复FIN和ACK，所以需要四次挥手

- 为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？

因为最后一次ACK发送出去之后，为了确保对方能够收到，因为报文一去已回最大的生存时间是2MSL，如果在这时间内没有收到请求，则代表对方收到了；如果对方没收到，则在2MSL里面会收到继续收到对方的终止连接报文。

## UDP首部格式

![](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204011501183.jpg)

- **源端口号**：字段长度16位，是可选项，没有源端口号时设置为0。 如用于某些单方面发送更新消息不需要接收端任何返回和应答。
- **目标端口号**：字段长度16位。
- **包长度**：字段长度16位。保存了UDP首部的长度跟数据的长度之和，单位为字节(8位字节)。
- **校验和**：是为了提供可靠的UDP首部和数据而设计

## TCP首部格式

![TCP首部格式](https://cdn.jsdelivr.net/gh/mouweng/FigureBed/img/202204011458572.jpg)

- **源端口号**：发送端端口,字段长16位。
- **目标端口号**：接收端端口,字段长16位。
- **序列号**：字段长32位。是指发送数据的位置，每发送一次数据，就累加一次该数据字节的大小。序号不会从0或者1开始，而是建立连接时由计算机生成的随机数作为其初始值。
- **确认应答号**：字段长32位。是指下一次应该接收到的数据的序列号。实际上，它是指已收到确认应答号减一为止的数据，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。
- **数据偏移**：字段长4位。可以看作是TCP首部的长度，单位为4字节(即32位)。最长能表示60字节。如果TCP首部为20字节，则偏移量可以设置为5。
- **保留**：字段长4位。预留以后扩展使用。
- **控制位**：字段长8位。每一位从左到右分别为CWR、ECE、URG、ACK、PSH、RST、SYN、FIN。
  - **CWR  (congestion window reduced)** 。与后面的ECE标志联动，用于通知对方已将拥塞窗口缩小。
  - **ECE（ECN-Echo）**。设置1用于通知对方已将拥塞窗口缩小。
  - **URG (urgent flag)** 。设置1表示包中有紧急处理的数据，在紧急指针中会涉及到。
  - **ACK (acknowledgement flag)** 。设置1表示确认应答的字段变为有效。TCP规定除了最初建立连接时的SYN包之外该位必须设置为1。
  - **PSH  (push flag)** 。设置1表示需要将接受到的数据立刻上传给上层应用协议。设置0则不需要立即传而是先进行缓存。
  - **RST  (reset flag)** 。设置1表示TCP连接中出现异常必须强制断开连接。（可以利用这个进行TCP重置攻击）
  - **SYN (synchronize flag)**。设置1表示建立连接。并在其序列号的字段进行序列号初始值的设定。
  - **FIN (fin flag)**。设置1表示断开连接。
- **窗口大小**：字段长16位。用于通知从相同TCP首部的确认应答号所指位置开始能够接收的数据大小(8字节)。TCP不允许发送超过此处所示大小的数据。不过，如果窗口位0，则表示可以发送窗口探测，以了解最新的窗口大小，但这个数据必须是1个字节。
- **校验和**：字段长16位。是为了提供可靠的TCP首部和数据而设计
- **紧急指针**：字段长16位。在URG设置1时有效，该字段的数值表示本报文段中紧急数据的指针。
- **选项**：可变长，最大长度为40字节。比如MSS、窗口扩大、时间戳字段等都可以记录在这。